# Akuru Institute — Deployment Guide

This document covers everything needed to deploy the application to a new server
or to move from the test subdomain (`test.akuru.edu.mv`) to the main domain (`akuru.edu.mv`).

---

## 1. Server Requirements

| Requirement | Minimum |
|-------------|---------|
| PHP | 8.4 (path: `/opt/alt/php84/usr/bin/php`) |
| MySQL | 8.0+ |
| Composer | 2.x |
| Git | any |
| Cron | required |
| HTTPS/SSL | required (Cloudflare or Let's Encrypt) |

---

## 2. First-Time Deployment

```bash
# 1. Clone the repo
cd ~
git clone https://github.com/ampilarey/akuru.git akuru.edu.mv
cd akuru.edu.mv

# 2. Install PHP dependencies
/opt/alt/php84/usr/bin/php /usr/local/bin/composer install --no-dev --optimize-autoloader

# 3. Copy and configure environment
cp .env.example .env
nano .env   # fill in all values (see Section 3 below)

# 4. Generate app key
/opt/alt/php84/usr/bin/php artisan key:generate

# 5. Run migrations
/opt/alt/php84/usr/bin/php artisan migrate --force

# 6. Seed roles/permissions (if needed)
/opt/alt/php84/usr/bin/php artisan db:seed --force

# 7. Set storage permissions
chmod -R 775 storage bootstrap/cache
chown -R akuruedu:akuruedu storage bootstrap/cache

# 8. Create storage symlink
/opt/alt/php84/usr/bin/php artisan storage:link

# 9. Cache config/routes for production
/opt/alt/php84/usr/bin/php artisan config:cache
/opt/alt/php84/usr/bin/php artisan route:cache
/opt/alt/php84/usr/bin/php artisan view:cache
```

---

## 3. Environment Variables (.env)

### Application

```env
APP_NAME="Akuru Institute"
APP_ENV=production
APP_KEY=                          # generated by key:generate
APP_DEBUG=false                   # MUST be false in production
APP_URL=https://akuru.edu.mv      # change to main domain
```

### Database

```env
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=akuru_prod            # your MySQL database name
DB_USERNAME=akuru_user            # your MySQL username
DB_PASSWORD=                      # your MySQL password
```

### Session / Cache / Queue

```env
SESSION_DRIVER=database
SESSION_LIFETIME=120
QUEUE_CONNECTION=database         # uses jobs table in MySQL
CACHE_STORE=database              # uses cache table in MySQL
```

> **Important:** `QUEUE_CONNECTION=database` means all queued emails and SMS
> are stored in the `jobs` table and processed by the queue worker.
> The worker MUST be running for emails/SMS to send.

### Mail (cPanel SMTP — noreply@akuru.edu.mv)

```env
MAIL_MAILER=smtp
MAIL_HOST=mail.akuru.edu.mv       # or your cPanel mail host
MAIL_PORT=465
MAIL_SCHEME=ssl
MAIL_USERNAME=noreply@akuru.edu.mv
MAIL_PASSWORD=Assampvig1@         # change after testing
MAIL_FROM_ADDRESS=noreply@akuru.edu.mv
MAIL_FROM_NAME="Akuru Institute"
ADMIN_NOTIFICATION_EMAIL=info@akuru.edu.mv   # receives new enrollment alerts
```

### SMS (Dhiraagu Gateway)

```env
DHIRAAGU_SMS_USERNAME=            # Dhiraagu API username
DHIRAAGU_SMS_PASSWORD=            # Dhiraagu API password
DHIRAAGU_API_URL=https://messaging.dhiraagu.com.mv/v1/api/sms
SMS_USE_DHIRAAGU=true
SMS_GATEWAY_ENABLED=false
```

### BML Payment Gateway

**UAT (testing):**
```env
BML_BASE_URL=https://api.uat.merchants.bankofmaldives.com.mv/public
BML_ENVIRONMENT=sandbox
BML_DEFAULT_CURRENCY=USD          # UAT account is USD
BML_APP_ID=1338278b-527d-4df5-b6c8-043dc17fb87e
BML_API_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...  # full JWT from BML portal
BML_AUTH_MODE=raw                 # send JWT without "Bearer " prefix
BML_RETURN_URL=https://test.akuru.edu.mv/payments/bml/return
BML_WEBHOOK_URL=https://test.akuru.edu.mv/webhooks/bml
```

**Production (when BML production account is ready):**
```env
BML_BASE_URL=https://api.merchants.bankofmaldives.com.mv/public
BML_ENVIRONMENT=production
BML_DEFAULT_CURRENCY=MVR
BML_APP_ID=                       # production App ID from BML portal
BML_API_KEY=                      # production API key from BML portal
BML_AUTH_MODE=raw
BML_RETURN_URL=https://akuru.edu.mv/payments/bml/return
BML_WEBHOOK_URL=https://akuru.edu.mv/webhooks/bml
BML_WEBHOOK_SECRET=               # set in BML portal, copy here
```

> **BML Portal checklist:**
> - Application domain must match `APP_URL` exactly
> - Webhook URL must be set to the `/webhooks/bml` path
> - Currency must match `BML_DEFAULT_CURRENCY`

---

## 4. Cron Job

Add this to the server crontab (`crontab -e`):

```cron
* * * * * cd /home/akuruedu/akuru.edu.mv && /opt/alt/php84/usr/bin/php artisan schedule:run >> /dev/null 2>&1
*/5 * * * * /home/akuruedu/akuru.edu.mv/restart-worker.sh
```

> **Note:** Replace `/home/akuruedu/akuru.edu.mv` with the actual app path on the new server.
> The scheduler runs these tasks automatically:
> - Every 10 min: reconcile pending BML payments (fallback if webhook missed)
> - Every hour: prune expired OTPs and stale enrollments
> - Every minute: scheduler heartbeat (used by `php artisan akuru:status`)

---

## 5. Queue Worker

Create the restart script once:

```bash
cat > /home/akuruedu/akuru.edu.mv/restart-worker.sh << 'SCRIPT'
#!/bin/bash
APP=/home/akuruedu/akuru.edu.mv
PHP=/opt/alt/php84/usr/bin/php
pgrep -f 'artisan queue:work' > /dev/null 2>&1 || nohup $PHP $APP/artisan queue:work --sleep=3 --tries=3 --max-time=3600 >> $APP/storage/logs/worker.log 2>&1 &
SCRIPT
chmod +x /home/akuruedu/akuru.edu.mv/restart-worker.sh
```

Start it immediately:

```bash
nohup /opt/alt/php84/usr/bin/php artisan queue:work --sleep=3 --tries=3 --max-time=3600 >> storage/logs/worker.log 2>&1 &
```

> The queue worker processes all queued emails and SMS (enrollment confirmations,
> admin notifications, approval/rejection emails). Without it, emails never send.

---

## 6. Pulling Updates (Routine Deployment)

```bash
cd ~/akuru.edu.mv
git pull origin main
/opt/alt/php84/usr/bin/php artisan migrate --force
/opt/alt/php84/usr/bin/php artisan config:clear
/opt/alt/php84/usr/bin/php artisan route:clear
/opt/alt/php84/usr/bin/php artisan cache:clear
/opt/alt/php84/usr/bin/php artisan queue:restart   # gracefully restart worker
```

---

## 7. Moving from test.akuru.edu.mv → akuru.edu.mv

1. **Update `.env`** on the production server:
   ```env
   APP_URL=https://akuru.edu.mv
   BML_RETURN_URL=https://akuru.edu.mv/payments/bml/return
   BML_WEBHOOK_URL=https://akuru.edu.mv/webhooks/bml
   ```

2. **Update BML portal:**
   - Application domain → `https://akuru.edu.mv`
   - Webhook URL → `https://akuru.edu.mv/webhooks/bml`
   - Switch to production credentials when ready

3. **Update crontab paths** to the new directory.

4. **Re-cache config:**
   ```bash
   php artisan config:cache && php artisan route:cache
   ```

5. **Verify:**
   ```bash
   php artisan akuru:status
   ```

---

## 8. Health Check

Run at any time to verify all systems:

```bash
php artisan akuru:status
```

Expected output:
```
✓  Database          connected
✓  Scheduler         last ran X seconds ago
✓  Queue             0 job(s) pending
✓  Failed jobs       none
```

If failed jobs appear:
```bash
php artisan queue:failed        # list failed jobs
php artisan queue:retry all     # retry all failed jobs
php artisan queue:flush         # clear all failed jobs
```

---

## 9. Key File Locations

| What | Path |
|------|------|
| Environment config | `~/{app}/.env` |
| Laravel logs | `~/{app}/storage/logs/laravel.log` |
| Queue worker logs | `~/{app}/storage/logs/worker.log` |
| Worker restart script | `~/{app}/restart-worker.sh` |
| Worker PID | `~/{app}/storage/logs/worker.pid` |
| Crontab | `crontab -l` |
| PHP binary | `/opt/alt/php84/usr/bin/php` |

---

## 10. Encrypted Fields

The following fields are encrypted at rest using Laravel's `encrypted` cast:
- `registration_students.national_id`
- `registration_students.passport`

The encryption key is `APP_KEY` in `.env`. **Never lose this key** — encrypted data
cannot be recovered without it. Back up `.env` securely.

If migrating from test to production with existing data, copy the same `APP_KEY`
or re-encrypt all records using:
```bash
php artisan students:encrypt-ids
```

---

## 11. Post-Deployment Checklist

- [ ] `APP_DEBUG=false` in production `.env`
- [ ] `APP_ENV=production`
- [ ] `APP_URL` matches actual domain
- [ ] SSL certificate active (HTTPS works)
- [ ] Mail sending tested (register a test account, check email arrives)
- [ ] SMS sending tested
- [ ] BML payment tested end-to-end (UAT first, then production)
- [ ] BML webhook URL updated in BML portal
- [ ] Cron running (`php artisan akuru:status` shows heartbeat)
- [ ] Queue worker running (emails sending)
- [ ] `ADMIN_NOTIFICATION_EMAIL` set to receive new enrollment alerts
- [ ] Storage symlink created (`php artisan storage:link`)
- [ ] File permissions set on `storage/` and `bootstrap/cache/`
